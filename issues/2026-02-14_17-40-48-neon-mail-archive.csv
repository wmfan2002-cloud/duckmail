"id","priority","phase","area","title","description","acceptance_criteria","test_mcp","review_initial_requirements","review_regression_requirements","dev_state","review_initial_state","review_regression_state","git_state","owner","refs","notes"
"NMA-000","P0","0.1","backend","接入 Neon 与迁移基建","新增 Drizzle 与 Neon 连接和 migration 脚手架，建立可重复执行的 schema 变更流程。","在本地与预发各执行 1 次 migration 后，mailboxes/messages/sync_runs/sync_events 表与核心索引均存在，并完成一次插入+查询 smoke 验证。","AUTOSERVER","连接层使用 serverless 友好驱动与连接池；迁移脚本幂等且失败可回滚；不破坏现有 Next.js 构建流程。","连续执行 migrate+rollback+migrate 三轮无脏状态；首页与关键路由构建通过且无新增构建错误。","已完成","已完成","已完成","已提交","","plan/2026-02-14_17-34-08-neon-mail-archive.md:219;plan/2026-02-14_17-34-08-neon-mail-archive.md:220;plan/2026-02-14_17-34-08-neon-mail-archive.md:221;package.json:14;db/schema.ts:13;lib/archive/db.ts:25;lib/archive/migration-runner.ts:91;scripts/db/migrate.ts:4;scripts/db/rollback.ts:16;scripts/db/smoke.ts:5;db/migrations/0000_initial.up.sql:1;README.md:71;package.json:13","picked_reason:P0 基建先行，后续 issue 依赖迁移与数据层。 | validation_limited:缺少 DATABASE_URL，无法在当前环境执行真实 migrate/rollback/smoke。 | manual_test:export DATABASE_URL=<neon_url> && pnpm db:migrate && pnpm db:smoke && pnpm db:rollback -- --steps=1 && pnpm db:migrate | evidence:pnpm db:migrate -- --plan 输出 0000_initial；pnpm exec tsc --noEmit 通过；pnpm build 通过；pnpm db:migrate 在无 DATABASE_URL 下按预期失败。 | risk:medium 未验证真实 Neon 连接与事务回滚链路。 | done_at:2026-02-14T17:50:26Z | blocked:git commit failed Author identity unknown，需要配置 git user.name/user.email。 | blocked_resolved:已配置 git user.name/user.email，重新执行提交。"
"NMA-010","P0","0.2","backend","加密与归档配置安全基线","实现邮箱凭据 AES-256-GCM 加密存储与环境变量校验，禁止明文凭据入库。","未配置 ARCHIVE_MASTER_KEY 或长度小于 32 字节时服务启动失败；mailboxes 写入后 password_enc 非明文并可通过受控解密校验。","AUTOSERVER","密钥只允许来自环境变量；日志与错误信息不得输出密码 token 正文；加解密 API 只暴露最小必要接口。","执行新增/更新/读取凭据全流程测试并检查日志脱敏；错误密钥场景返回可观测错误且不泄露敏感信息。","已完成","已完成","已完成","已提交","","plan/2026-02-14_17-34-08-neon-mail-archive.md:222;plan/2026-02-14_17-34-08-neon-mail-archive.md:192;plan/2026-02-14_17-34-08-neon-mail-archive.md:193;plan/2026-02-14_17-34-08-neon-mail-archive.md:195;lib/archive/crypto.ts:22;lib/archive/mailbox-repository.ts:22;app/api/archive/mailboxes/route.ts:21;scripts/archive/check-config.ts:3;scripts/archive/crypto-self-test.ts:3;README.md:91;package.json:16","picked_reason:P0 安全基线优先，后续导入与同步必须依赖密文存储。 | validation_limited:当前环境无可用 DATABASE_URL，未执行真实 mailboxes 写库与解密 API 端到端验证。 | manual_test:ARCHIVE_MASTER_KEY=<32+> DATABASE_URL=<neon_url> ARCHIVE_DEBUG_TOKEN=<token> 启动服务后执行 POST /api/archive/mailboxes 写入，再以 GET /api/archive/mailboxes?email=<x>&revealCredential=1 + x-archive-debug-token 验证受控解密。 | evidence:ARCHIVE_MASTER_KEY 缺失与短密钥场景均返回失败；pnpm archive:check-config 在合法配置下通过；pnpm archive:crypto-self-test 通过且密文不等于明文；pnpm exec tsc --noEmit 与 pnpm build 通过。 | risk:medium 尚未在真实 Neon 实例验证 password_enc 入库与受控解密链路。 | done_at:2026-02-14T17:57:35Z"
"NMA-020","P1","1.1","backend","邮箱账号管理 API 与批量导入","实现单个添加、批量导入、列表、启停与 test-login API，并输出逐行导入结果。","导入 500 行有效邮箱时成功率 >= 99%，失败行返回行号和原因；test-login 对无效凭据返回可识别错误码。","AUTOSERVER","入参校验覆盖 CSV 与文本两种格式；接口响应字段保持稳定；导入过程限流避免触发上游抖动。","执行 500 行导入回归与重复导入幂等检查；无效格式不会写库；关键 API 错误率 < 1%。","已完成","已完成","已完成","已提交","","plan/2026-02-14_17-34-08-neon-mail-archive.md:227;plan/2026-02-14_17-34-08-neon-mail-archive.md:228;plan/2026-02-14_17-34-08-neon-mail-archive.md:232;plan/2026-02-14_17-34-08-neon-mail-archive.md:266;plan/2026-02-14_17-34-08-neon-mail-archive.md:135;app/api/archive/mailboxes/route.ts:21;app/api/archive/mailboxes/import/route.ts:18;app/api/archive/mailboxes/test-login/route.ts:15;app/api/archive/mailboxes/[id]/route.ts:11;lib/archive/mailbox-import.ts:151;lib/archive/provider-client.ts:29;lib/archive/mailbox-repository.ts:73;scripts/archive/import-parser-self-test.ts:11;scripts/archive/test-login-self-test.ts:3;README.md:104;package.json:18","picked_reason:先完成后端邮箱管理 API，供 NMA-030 前端管理页直接复用。 | validation_limited:未连接真实 DATABASE_URL 与上游 mail.tm，未执行真实 500 行入库与远端 test-login 回归。 | manual_test:ARCHIVE_MASTER_KEY=<32+> DATABASE_URL=<neon_url> pnpm dev 后调用 POST /api/archive/mailboxes/import(500行)；PATCH /api/archive/mailboxes/:id 切换启停；POST /api/archive/mailboxes/test-login 校验 INVALID_CREDENTIALS 错误码。 | evidence:pnpm archive:import-parser-self-test 验证 500 行解析与逐行失败定位；pnpm archive:test-login-self-test 验证错误码稳定；pnpm exec tsc --noEmit 与 pnpm build 通过。 | risk:medium 真实数据库写入吞吐与远端登录限流尚未在生产等价环境验证。 | done_at:2026-02-14T18:02:43Z"
"NMA-030","P1","1.2","frontend","邮箱管理页与导入交互","实现邮箱管理前端页面，包含表格、导入弹窗、错误回显与启停操作入口。","导入结果可展示 success/failed/reason 明细；500 行导入后页面在 2 秒内完成结果渲染并支持错误行筛选。","AUTOFRONTEND","表单校验与后端错误码映射一致；长列表渲染不阻塞主线程；交互文案明确且无歧义。","执行 500 行导入与分页浏览回归；主流桌面分辨率无布局溢出；关键操作可重复执行且状态一致。","已完成","已完成","已完成","已提交","","plan/2026-02-14_17-34-08-neon-mail-archive.md:229;plan/2026-02-14_17-34-08-neon-mail-archive.md:232;plan/2026-02-14_17-34-08-neon-mail-archive.md:209;app/archive/page.tsx:74;app/archive/page.tsx:145;app/archive/page.tsx:192;README.md:106;app/api/archive/mailboxes/import/route.ts:18;app/api/archive/mailboxes/[id]/route.ts:11","picked_reason:后端管理 API 已就绪，先补前端管理页可立即验证导入与启停交互。 | validation_limited:未连接真实数据库执行 500 行端到端导入与多分辨率人工巡检。 | manual_test:启动服务后访问 /archive，导入 500 行样本并切换 success/failed 筛选，确认 2 秒内可交互；执行启停按钮并刷新验证状态一致。 | evidence:前端页面已接入导入结果分页与错误回显；pnpm exec tsc --noEmit 与 pnpm build 通过，构建产物包含 /archive 路由。 | risk:low 交互链路完整，主要剩余风险在真实大样本设备上的渲染体验验证。 | done_at:2026-02-14T18:15:43Z"
"NMA-040","P0","2.1","backend","同步 Worker 核心流程与幂等入库","实现 token/messages/detail 拉取链路、消息 upsert 去重和失败退避。","手动触发同步可完成列表+详情抓取并写库；重复运行同批次消息无重复记录，去重准确率保持 100%。","AUTOSERVER","全局 QPS 限制 <= 6 且批次并发 3~4 可配置；失败退避策略可追踪；单邮箱失败不阻断其他邮箱。","执行 24 小时小流量连续同步回归无致命中断；失败重试后结果最终一致；sync_events 记录完整。","已完成","已完成","已完成","已提交","","plan/2026-02-14_17-34-08-neon-mail-archive.md:235;plan/2026-02-14_17-34-08-neon-mail-archive.md:237;plan/2026-02-14_17-34-08-neon-mail-archive.md:240;plan/2026-02-14_17-34-08-neon-mail-archive.md:182;README.md:90;lib/archive/sync-worker.ts:314;lib/archive/sync-repository.ts:47;lib/archive/mailtm-client.ts:62;app/api/archive/sync/run/route.ts:21;scripts/archive/mailtm-client-self-test.ts:3;README.md:112;package.json:20","picked_reason:P0 同步链路是调度、检索、日志与可观测性的共同前置。 | validation_limited:缺少可用 DATABASE_URL 与真实 mail.tm 凭据，未执行数据库写入与 24h 连续同步回归。 | manual_test:配置 ARCHIVE_MASTER_KEY/DATABASE_URL 后，POST /api/archive/sync/run 触发同步；检查 sync_runs/sync_events 与 messages 去重（重复触发同批次 remote_id 应保持单条）。 | evidence:pnpm archive:mailtm-client-self-test 覆盖 token->list->detail 解析链路；pnpm archive:test-login-self-test 与 pnpm archive:import-parser-self-test 通过；pnpm exec tsc --noEmit 与 pnpm build 通过。 | risk:medium 真实上游限流与长稳运行退避效果尚未在生产等价负载下验证。 | done_at:2026-02-14T18:07:33Z"
"NMA-050","P1","2.2","backend","Scheduled 与 Background 调度链路打通","实现 dispatch 与 background worker 协作，按 due 邮箱触发同步并记录 run 状态。","Scheduled 每 10 分钟触发 dispatch；单次 dispatch 控制在 30 秒内；重任务由 background 完成且 sync_runs 状态可查询。","AUTOE2E","避免全量重写规则影响 API 路由；定时触发与手动触发复用同一服务；超时与重入行为有保护策略。","验证 schedule->dispatch->worker 三次连续成功；故障注入下 run 状态和错误日志完整；无重复触发风暴。","已完成","已完成","已完成","已提交","","plan/2026-02-14_17-34-08-neon-mail-archive.md:236;plan/2026-02-14_17-34-08-neon-mail-archive.md:177;plan/2026-02-14_17-34-08-neon-mail-archive.md:178;plan/2026-02-14_17-34-08-neon-mail-archive.md:179;netlify.toml:8;lib/archive/sync-worker.ts:359;lib/archive/sync-repository.ts:104;app/api/archive/sync/dispatch/route.ts:13;app/api/archive/sync/background/route.ts:12;app/api/archive/sync/scheduled/route.ts:14;lib/archive/admin-auth.ts:3;README.md:112","picked_reason:在已完成同步 worker 基础上补齐调度链路，解锁自动化同步能力。 | validation_limited:当前环境未连真实 DATABASE_URL，无法执行 schedule->dispatch->background 三轮落库回归。 | manual_test:配置 ARCHIVE_ADMIN_TOKEN/DATABASE_URL 后连续 3 次调用 POST /api/archive/sync/scheduled，校验 dispatch 耗时<30s、queue run 状态从 queued->dispatching->completed/failed，并验证无触发风暴。 | evidence:pnpm archive:mailtm-client-self-test 通过；pnpm exec tsc --noEmit 与 pnpm build 通过；新增 dispatch/background/scheduled 路由均被构建识别。 | risk:medium 调度触发频率和后台消费在真实生产并发下尚未完成连续观测。 | done_at:2026-02-14T18:11:47Z"
"NMA-060","P1","3.1","backend","消息检索详情与删除策略 API","实现消息列表筛选、正文详情与 local/remote/both 删除模式 API。","支持 mailbox/domain/from/subject/q/start/end 组合筛选；mode=local|remote|both 三种删除返回一致状态并可审计。","AUTOSERVER","查询参数与索引策略匹配避免全表扫描；删除流程幂等并定义远端失败降级；审计日志记录删除来源。","回归关键词检索、时间范围、多条件组合和三种删除模式；远端删除失败重试不造成本地状态错乱。","已完成","已完成","已完成","已提交","","plan/2026-02-14_17-34-08-neon-mail-archive.md:243;plan/2026-02-14_17-34-08-neon-mail-archive.md:244;plan/2026-02-14_17-34-08-neon-mail-archive.md:248;plan/2026-02-14_17-34-08-neon-mail-archive.md:153;plan/2026-02-14_17-34-08-neon-mail-archive.md:159;app/api/archive/messages/route.ts:29;app/api/archive/messages/[id]/route.ts:39;lib/archive/message-repository.ts:98;lib/archive/message-service.ts:36;lib/archive/mailtm-client.ts:122;scripts/archive/mailtm-client-self-test.ts:67;README.md:125","picked_reason:先补检索/删除 API，供 NMA-070 前端页面直接联调。 | validation_limited:未连接真实 DATABASE_URL 与 mail.tm 账号，未执行远端删除失败重试与本地状态一致性实测。 | manual_test:调用 GET /api/archive/messages?mailbox=...&q=...&start=...&end=... 验证组合筛选；分别执行 DELETE /api/archive/messages/:id?mode=local|remote|both，检查返回 code(DELETE_OK/DELETE_PARTIAL) 与 sync_events 审计记录。 | evidence:mail.tm 客户端自测覆盖 token/list/detail/delete；pnpm exec tsc --noEmit 与 pnpm build 通过，构建产物包含 messages API 路由。 | risk:medium 远端删除异常与本地降级在真实网络抖动场景下尚未完整回归。 | done_at:2026-02-14T18:20:23Z"
"NMA-070","P1","3.2","frontend","归档检索页与同步日志可视化","实现归档查询界面、正文详情展示、删除反馈及同步记录与错误日志展示。","可按关键词检索正文并查看详情；执行删除后页面状态 5 秒内刷新；最近同步记录与失败原因可查看。","AUTOE2E","列表分页与详情加载采用渐进式请求；错误提示与后台错误码一致；危险操作提供二次确认。","执行 导入->同步->检索->删除 端到端回归通过；网络抖动场景下页面状态一致且可恢复。","已完成","已完成","已完成","已提交","","plan/2026-02-14_17-34-08-neon-mail-archive.md:245;plan/2026-02-14_17-34-08-neon-mail-archive.md:248;plan/2026-02-14_17-34-08-neon-mail-archive.md:263;plan/2026-02-14_17-34-08-neon-mail-archive.md:169;app/archive/search/page.tsx:73;app/archive/search/page.tsx:180;app/api/archive/sync/runs/route.ts:18;lib/archive/sync-repository.ts:279;app/archive/page.tsx:232;README.md:107","picked_reason:检索与日志前端依赖 NMA-060/NMA-050，当前可直接串联交付可视化闭环。 | validation_limited:当前环境未执行完整 导入->同步->检索->删除 真实端到端链路与网络抖动恢复测试。 | manual_test:访问 /archive/search，执行组合检索并打开详情；删除同一消息后观察 5 秒内列表刷新；刷新同步日志并核对最近 runs/errors 与后端数据一致。 | evidence:新增 /archive/search 页面与 /api/archive/sync/runs 接口；pnpm exec tsc --noEmit、pnpm build、pnpm archive:mailtm-client-self-test 通过。 | risk:medium 页面状态一致性在弱网和大样本日志下仍需真实环境压测。 | done_at:2026-02-14T18:24:31Z"
"NMA-080","P2","4","both","稳定性增强：FTS/TTL/指标告警","实现全文检索索引优化、TTL 保留策略任务与失败率/延迟指标可观测。","FTS 启用后 10 万样本关键词检索 p95 < 1.5s；TTL 每日任务成功执行并记录删除统计；失败率和延迟指标可查询。","AUTOE2E","性能优化不改变检索语义；TTL 保留窗口可配置且可停用；指标口径与统计周期写入文档。","对比优化前后查询延迟与资源占用；模拟失败任务可触发告警；连续 7 天监控无数据缺口。","已完成","已完成","已完成","已提交","","plan/2026-02-14_17-34-08-neon-mail-archive.md:250;plan/2026-02-14_17-34-08-neon-mail-archive.md:251;plan/2026-02-14_17-34-08-neon-mail-archive.md:252;plan/2026-02-14_17-34-08-neon-mail-archive.md:253;plan/2026-02-14_17-34-08-neon-mail-archive.md:256;db/migrations/0001_stability.up.sql:1;lib/archive/message-repository.ts:94;lib/archive/message-repository.ts:195;lib/archive/ttl-maintenance.ts:15;app/api/archive/maintenance/ttl/route.ts:27;app/api/archive/metrics/route.ts:36;lib/archive/sync-repository.ts:323;lib/archive/metrics.ts:21;scripts/archive/metrics-self-test.ts:3;README.md:139;package.json:21","picked_reason:收口阶段补齐 FTS/TTL/指标，降低长期运行风险并增强可观测性。 | validation_limited:未在 10 万真实样本与 7 天连续监控窗口下执行性能/告警完整回归。 | manual_test:配置 DATABASE_URL 后先执行 pnpm db:migrate；调用 GET /api/archive/metrics?windowHours=24 观察 failureRate/p95 与 alerts；调用 POST /api/archive/maintenance/ttl(dryRun=true/false) 验证删除统计与 run/event 记录。 | evidence:pnpm db:migrate -- --plan 已包含 0001_stability；pnpm archive:metrics-self-test 与 pnpm archive:mailtm-client-self-test 通过；pnpm exec tsc --noEmit 与 pnpm build 通过。 | risk:medium FTS 性能收益与告警阈值仍需线上真实流量校准。 | done_at:2026-02-14T18:29:58Z"
